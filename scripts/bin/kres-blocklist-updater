#!/bin/sh

set -eu
umask 0002

printf '%s\n' 'Updating blocklist zone...'

# Create data directory if it does not exist
if [ ! -e "${KRESD_DATA_DIR:?}"/hblock/ ]; then
	mkdir -p "${KRESD_DATA_DIR:?}"/hblock/
fi

# Create sources file if it does not exist
if [ ! -e "${KRESD_DATA_DIR:?}"/hblock/sources.list ]; then
	awk '/^HBLOCK_SOURCES_BUILTIN=/{f=1;next}/^EOF$/{f=0}f{print($1)}' "$(command -v hblock)" > "${KRESD_DATA_DIR:?}"/hblock/sources.list
fi

# Create allowlist file if it does not exist
if [ ! -e "${KRESD_DATA_DIR:?}"/hblock/allow.list ]; then
	touch "${KRESD_DATA_DIR:?}"/hblock/allow.list
fi

# Create denylist file if it does not exist
if [ ! -e "${KRESD_DATA_DIR:?}"/hblock/deny.list ]; then
	touch "${KRESD_DATA_DIR:?}"/hblock/deny.list
fi

# Generate blocklist zone
hblock
